## i-bem.js: Руководство пользователя

### Общие сведения

### i-bem.js: Клиентский Javascript-фреймворк для БЭМ

i-bem.js — специализированный JavaScript-фреймворк для веб-разработки в рамках [БЭМ-методологии](http://ru.bem.info/method/). 
С помощью i-bem.js можно:

 * разрабатывать веб-интерфейс в терминах блоков, элементов, модификаторов;
 * описывать логику работы блока в декларативном стиле — как набор состояний;
 * легко интегрировапть JavaScript-код с CSS в стиле БЭМ и BEMHTML-шаблонами;
 * гибко переопределять поведение библиотечных блоков.

i-bem.js не может:

 * работать с состоянием на сервере (только клиентский JavaScript);
 * заменить высокоуровневые фреймворки общего назначения, подобные jQuery.

#### БЭМ-методология и JavaScript

С точки зрения БЭМ-методологии веб-интерфейс строится из независимых **блоков** (внутри которых могут 
быть выделены **элементы**). И блоки, и элементы могут иметь состояния, описываемые **модификаторами**.

Работа веб-интерфейса обеспечивается несколькими **технологиями** (HTML, CSS, JS...), 
и описание блока складывается из реализаций в этих технологиях:
 * CSS — описывает внешний вид блока;
 * BEMHTML — шаблоны для генерации HTML-представления блока;
 * JS — описывает **поведение** блока.

Фреймворк i-bem.js позволяет разложить клиентский JavaScript на компоненты в терминах БЭМ:

 + **Блок** — JS-компонент, описывающий поведение и состояние соответствующего элемента веб-интерфейса.
 Как и при разработке CSS по БЭМ-методологии, реализация блока описывает класс объектов — однотипных элементов интерфейса. 
 На каждой странице может размещаться более одного **экземпляра** блока. Каждому экземпляру блока соответствует JS-объект, 
 динамически создаваемый в памяти браузера.
 + **Элементы** — Особые поля экземпляра блока, способные иметь состояния (модификаторы).  
 + **Модификаторы** — Особые поля экземпляра блока, хранящие информацию о состоянии блока и его элементов.



#### Как использовать i-bem.js

Фреймворк i-bem.js входит в состав библиотеки [bem-core](http://github.com/bem/bem-core/).

Можно использовать i-bem.js как часть полного стека БЭМ-инструментов. Свой проект удобно создавать 
на основе шаблонного репозитория [project-stub](http://github.com/bem/project-stub/), в котором 
подключены все необходимые библиотеки и настроена установка БЭМ-инструментов. 

Если не планируется использование других технологий БЭМ-платформы, можно
подключить библиотеку bem-core в существующий проект любым доступным способом.

Исходный код i-bem.js — JS-реализация блока [i-bem](http://github.com/bem/bem-core/tree/v1/common.blocks/i-bem/).
Существенные компоненты реализации: 
 * Прототип описания блока `i-bem.vanilla.js`
 * Реализация элемента [i-bem__dom](https://github.com/bem/bem-core/blob/v1/common.blocks/i-bem/\_\_dom/i-bem\_\_dom.js).
 * Внутренние хелперы `i-bem__internal.vanilla.js`

Зависимости: 

 * jQuery. При использовании bem-core отдельная установка jQuery не требуется.
 * Модульная система [ymaps/modules](https://github.com/ymaps/modules). 
 * ymaps-модули `inherit`, `next-tick`, `vow` из библиотеки bem-core.

#### Сборка

Разработка в рамках БЭМ-методологии ведется модульно: каждый блок программируется отдельно, финальный исходный
код веб-страниц формируется из описаний блоков с помощью процедур **сборки**.

В файловой системе блок удобно представлять в виде каталога, а реализацию блока 
в каждой из технологий — в виде отдельного файла:

    desktop.blocks/
                   myblock/
                           myblock.css
                           myblock.js
                           myblock.bemhtml
                           ...

    desktop.blocks/
                   otherblock/
                           otherblock.css
                           otherblock.js
                           otherblock.bemhtml
                           ...

Для каждой веб-страницы код использованных на ней блоков должен быть собран в единые файлы: 

    desktop.bundles/
                    index/
                         index.html
                         index.css
                         index.js
                         ...

Автоматизацию сборки кода результирующих веб-страниц из отдельных описаний блоков осуществляют
инструменты пакета [bem-tools](http://github.com/bem/bem-tools/). 

*?? Можно ли пользоваться i-bem.js, не используя bem-tools?*

#### Почему i-bem.js так называется

В соответствии с БЭМ-методологией, базовая JS-библиотека БЭМ-платформы изначально разрабатывалась
как особый служебный блок. Такой подход позволяет работать с базовыми библиотеками так же, как
и с обычными блоками. В частности, структурировать код в терминах элементов и модификаторов и 
гибко переопределять поведение библиотеки на разных уровнях переопределения.

Служебным блокам в БЭМ принято давать имена с префиксом `i-`. Таким образом, имя `i-bem.js` 
читается как «реализация блока `i-bem` в технологии `js`».


### Привязка JavaScript к HTML

JavaScript-компоненты в i-bem.js — объекты, соответствующие блокам — служат для «оживления»
HTML-элементов страницы. Типовая задача JS-блока — привязать обработку определенных событий
к указанному HTML-фрагменту. 

Преимущества этого подхода к связи HTML и JavaScript-компонент: 

 * естественная деградация интерфейса на клиентах с отключенным JavaScript;
 * _прогрессивный рендеринг_ — возможность начать отрисовку элементов интерфейса до окончания загрузки всех данных страницы (например, изображений).

Первичным для i-bem.js является DOM-дерево документа, поэтому информация о привязанных к 
элементу блоках размещается в DOM-дереве. Соотношение блоков и HTML-элементов не обязательно 
должно быть одно-однозначным. Возможны следующие типы связи: 
 
 + На одном DOM-элементе размещен один JS-блок.

 + На одном DOM-элементе размещено несколько JS-блоков. 
 
   Техника размещения нескольких блоков на одном DOM-элементе в БЭМ-методологии называется **микс** 
   и применяется также для CSS-реализаций блоков. 

 + Один JS-блок размещен одновременно на нескольких DOM-элементах.
   Такой дизайн позволяет прозрачно реализовывать блоки, состоящие из нескольких компонент, 
   сосотяние которых должно быть согласовано. Например, виджет notebook или маркер, обозначающий
   точку на карте и связанное с ним описание точки в списке рядом с картой.

 + JS-блок не привязан к DOM-элементу.
   В таких блоках можно размещать инфраструктурный код, решающий общие задачи интерфейса: связь с бэкэндом, 
   общие вычисления и т.п.

#### Синтаксис привязки блоков

Чтобы привязать блок к HTML-элементу, необходимо: 

 1. Включить имя блока в список классов HTML-элемента (атрибут `class`).
 2. Включить класс `i-bem` в список классов HTML-элемента.
 3. Поместить параметры блока в атрибут `onclick`.

Пример: 

    <div class="myblock anotherblock i-bem"
        onclick="return { 
            myblock: {},
            anotherblock: {}
        }">
        <span class="myblock\_\_item"></span>
     </div>


#### Синтаксис передачи параметров

Параметры блока — произвольный JavaScript-объект, который будет передан блоку в момент инициализации. 
Параметры позволяют модифицировать поведение экземпляра блока, привязанного к данному DOM-узлу.

В значении атрибута `onclick` указываются параметры _всех JS\_блоков, размещенных на данном узле_. 
Параметры передаются с помощью конструкции `return` в виде хэша:
 + ключ — имя блока;
 + значение — хэш параметров данного блока. Если данному экземпляру блока не требуются 
   параметры, указывается пустой хэш `{}`.

Такой формат параметров продиктован следующими соображениями:

 * Указание имени блока в параметрах позволяет избежать необходимости парсить значение атрибута `class`,
   что упрощает и ускоряет инициализацию блоков. Это же решение позволяет размещать несколько блоков на одном 
   DOM-узле без необходимости множить атрибуты элемента.
 * Передача параметров в виде нативного JS-объекта позволяет обходиться для этой цели одним HTML-атрибутом
   и передавать в качестве параметров произвольный JS-код.

*NB: на некоторых уровнях переопределения для передачи блока может использоваться другой HTML-атрибут. Например, в 
библиотеке bem-bl для блоков сенсорных интерфейсов используется атрибут `ondblclick`.*

#### Зарезервированные имена параметров

В i-bem.js зарезервированы следующие имена параметров, которые обрабатываются особым образом при инцииализации
всех блоков.

* **id**
    Параметр `id` позволяет размещать один блок на нескольких DOM-узлах. Для этого на обоих узлах в параметрах 
    данного блока указывается один и тот же `id`:

    
    <div class="myblock i-bem" onclick="return { myblock: { id: 1 }}"></div>
    ...
    <span class="myblock i-bem" onclick="return { myblock: { id: 1 }}"></span>

    В результате при инциализации блоков будет создан один JS-объект, содержащий ссылки на оба DOM-узла. 
    _!!уточнить, верно ли!!_

### Описание блока

JS-реализация блока описывает функциональность определенного класса элементов веб-интерфейса. В конкретных 
интерфейсах каждый блок может быть представлен несколькими экземплярами, реализующими функциональность 
всего класса. При этом каждый из экземпляров блока имеет собственное состояние, независимое от остальных.

В терминах парадигмы объектно-ориентированного программирования: 
 * блок — класс;
 * экземпляр блока — экземпляр класса.

В соответствии с ООП, вся функциональность блока реализуется модульно в _методах_ класса. 
Методы блока подразделяются на:
 * методы экземпляра блока;
 * статические методы.


#### Синтаксис декларации

Технически декларация блока является переопределением ymaps-модуля `i-bem__dom`. 

Блоки, имеющие DOM-представление (привязанные к DOM-элементу) декларируются с помощью 
метода `DOM.decl`, принимающим три параметра: 

1. Селектор блока. В качестве селектора может выступать: 
    + Строка — Имя блока.
    + Хэш — Описание блока с указанием значений модификаторов, родительских блоков (классов), повдение которых 
    должен унаследовать данный блок.

2. Методы экземпляра блока — хэш.

3. Статические методы — хэш.


    modules.define('i-bem\_\_dom', function(provide, DOM) {

    DOM.decl(/* селектор блока \*/,
        { 
            /* методы экземпляра \*/
        },
        {
            /* статические методы \*/
        }
    );
    
    provide(DOM);
    });

Блоки, не имеющие DOM-представления, 

#### Селектор блока


#### Контекст

Ссылка на экземпляр блока (контекст) доступна в коде блока с помощью ключевого слова `this`.

Контекст содержит зарезервированные поля: 
 + `this.__self`: Ссылается на статические методы класса, к которому принадлжит экземпляр.
    Вызов статического метода: 

    DOM.decl('myblock', {
        method: function() {
            this.\_\_self.staticMethod();
            this.doMore();
        }, 
        {}
    });



 + `this.__base`: Ссылается на реализацию метода в базовом классе, которому наследует данный.
    Позволяет сделать super call: 

    DOM.decl('myblock', {
        method: function() {
            this.\_\_base();
            this.doMore();
        }, 
        {}
    });


#### Зарезервированные методы



### Элементы

### Состояния блока

#### Инициализация

#### Модификаторы

#### Деструкция

### События

### Взаимодействие блоков

Селекторы

`BEM.blocks['name']`

### Кастомизация блоков

### РАЗНОЕ

#### Ленивая инициализация

#### Блоки без DOM-представления

